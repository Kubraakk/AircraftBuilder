{% extends "userpanel/base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center">Üretilen Uçaklar</h2>

    <div id="error-message" class="alert alert-danger d-none text-center"></div>

    <table class="table table-bordered mt-3" id="aircraft-table-container">
        <thead class="table-dark">
            <tr>
                <th>Uçak Modeli</th>
                <th>Kullanılan Parçalar</th>
                <th>Üretim Tarihi</th>
            </tr>
        </thead>
        <tbody id="aircraft-table">
        </tbody>
    </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const accessToken = localStorage.getItem("access_token");

    if (!accessToken) {
        window.location.href = "{% url 'login' %}";
        return;
    }

    const aircraftTable = document.getElementById("aircraft-table");
    const aircraftTableContainer = document.getElementById("aircraft-table-container");
    const errorMessage = document.getElementById("error-message");

    function fetchAircrafts() {
        fetch("/api/parts/assembly/", {
            method: "GET",
            headers: { "Authorization": `Bearer ${accessToken}` }
        })
        .then(response => {
            if (response.status === 403) {
                throw new Error("Bu sayfayı görüntüleme yetkiniz yok.");
            }
            return response.json();
        })
        .then(data => {
            console.log("API'den Gelen Veri:", data);

            if (!data || data.length === 0) {
                aircraftTable.innerHTML = "<tr><td colspan='3' class='text-center'>Bu sayfayı görüntüleme yetkiniz yok.</td></tr>";
                return;
            }

            aircraftTable.innerHTML = "";

            data.forEach(item => {
                let partsUsed = item.parts_used.map(part => `${part.part_name} (${part.quantity_used})`).join(", ");
                let formattedDate = new Date(item.created_at).toLocaleString("tr-TR", {
                    year: "numeric", month: "long", day: "numeric",
                    hour: "2-digit", minute: "2-digit"
                });

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${item.aircraft_name}</td>
                    <td>${partsUsed}</td>
                    <td>${formattedDate}</td>
                `;
                aircraftTable.appendChild(row);
            });
        })
        .catch(error => {
            console.error(error.message);
            errorMessage.innerText = error.message;
            errorMessage.classList.remove("d-none");
            aircraftTableContainer.style.display = "none";
        });
    }

    fetchAircrafts();
});
</script>
{% endblock %}
